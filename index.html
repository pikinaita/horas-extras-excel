<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Gastos - Dropbox</title>
    <!-- Dropbox SDK -->
    <script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
            color: white;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        h1 { 
            text-align: center; 
            margin-bottom: 30px;
            font-size: 1.8rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        h2 {
            margin-bottom: 15px;
            font-size: 1.3rem;
            color: #00d4ff;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #b8b8b8;
            font-size: 0.9rem;
            font-weight: 500;
        }
        input, select {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 15px;
            border: none;
            border-radius: 10px;
            background: #1a1a1a;
            color: white;
            font-size: 1rem;
            -webkit-appearance: none;
        }
        input:focus, select:focus {
            outline: 2px solid #00d4ff;
            outline-offset: 2px;
        }
        button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,212,255,0.4);
        }
        .btn-success {
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            color: #1a1a1a;
        }
        .btn-danger {
            background: linear-gradient(135deg, #ff4757, #cc3344);
            color: white;
        }
        .status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 500;
            display: none;
        }
        .status.success { background: rgba(0,255,136,0.2); border: 1px solid #00ff88; }
        .status.error { background: rgba(255,71,87,0.2); border: 1px solid #ff4757; }
        .status.info { background: rgba(0,212,255,0.2); border: 1px solid #00d4ff; }
        
        .hidden { display: none !important; }
        
        .expense-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .expense-item {
            background: rgba(255,255,255,0.05);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .expense-info { flex: 1; }
        .expense-amount { 
            font-size: 1.2rem; 
            font-weight: 700;
            color: #00ff88;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #00d4ff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .file-path-display {
            background: rgba(0,212,255,0.1);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            word-break: break-all;
            font-size: 0.85rem;
            color: #00d4ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üí∞ Gestor de Gastos</h1>
        
        <div id="status" class="status"></div>

        <!-- LOGIN SECTION -->
        <div id="loginSection" class="card">
            <h2>üîê Conectar con Dropbox</h2>
            <p style="margin-bottom: 20px; color: #b8b8b8;">
                Esta app se conecta directamente a tu Dropbox para leer y modificar el archivo en tiempo real.
            </p>
            <button class="btn-primary" onclick="login()">
                Conectar con Dropbox
            </button>
        </div>

        <!-- APP SECTION -->
        <div id="appSection" class="hidden">
            <!-- Configuraci√≥n archivo -->
            <div class="card">
                <h2>üìÅ Archivo en Dropbox</h2>
                <label>Ruta del archivo:</label>
                <input type="text" id="filePath" value="/gastos.csv" placeholder="/carpeta/archivo.csv">
                <button class="btn-primary" onclick="loadFile()">
                    Cargar Archivo
                </button>
                <button class="btn-danger" onclick="logout()">
                    Cerrar Sesi√≥n
                </button>
            </div>

            <!-- A√±adir gasto -->
            <div id="addExpenseSection" class="card hidden">
                <h2>‚ûï A√±adir Nuevo Gasto</h2>
                
                <label>Fecha:</label>
                <input type="date" id="fecha">
                
                <label>Concepto:</label>
                <input type="text" id="concepto" placeholder="Ej: Supermercado, Gasolina...">
                
                <label>Categor√≠a:</label>
                <select id="categoria">
                    <option value="Alimentaci√≥n">Alimentaci√≥n</option>
                    <option value="Transporte">Transporte</option>
                    <option value="Vivienda">Vivienda</option>
                    <option value="Ocio">Ocio</option>
                    <option value="Salud">Salud</option>
                    <option value="Educaci√≥n">Educaci√≥n</option>
                    <option value="Otros">Otros</option>
                </select>
                
                <label>Importe (‚Ç¨):</label>
                <input type="number" id="importe" step="0.01" placeholder="0.00">
                
                <button class="btn-success" onclick="addExpense()">
                    Guardar Gasto en Dropbox
                </button>
            </div>

            <!-- Lista de gastos -->
            <div id="expenseListSection" class="card hidden">
                <h2>üìä Gastos Registrados</h2>
                <div id="expenseList" class="expense-list">
                    <p style="text-align: center; color: #b8b8b8;">Carga un archivo para ver los gastos</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURACI√ìN - App Key proporcionado por el usuario
        const CLIENT_ID = 'gp93qf4f6ozo0oh';
        
        // Variables globales
        let dbx = null;
        let expenses = [];
        let currentFilePath = '';

        // Mostrar/ocultar secciones
        function showSection(id) {
            document.querySelectorAll('.card').forEach(el => {
                if (!el.id.includes('Section') || el.id === 'loginSection') return;
            });
        }

        // Mostrar estado
        function showStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            
            if (type !== 'info') {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 5000);
            }
        }

        // LOGIN - OAuth2 Dropbox
        function login() {
            const redirectUri = window.location.origin + window.location.pathname;
            const authUrl = `https://www.dropbox.com/oauth2/authorize?client_id=${CLIENT_ID}&response_type=token&redirect_uri=${encodeURIComponent(redirectUri)}`;
            window.location.href = authUrl;
        }

        // LOGOUT
        function logout() {
            localStorage.removeItem('dropbox_token');
            dbx = null;
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('appSection').classList.add('hidden');
            showStatus('Sesi√≥n cerrada correctamente', 'info');
        }

        // Verificar token al cargar la p√°gina
        window.onload = function() {
            // Verificar si viene de OAuth (token en URL)
            const hash = window.location.hash;
            if (hash) {
                const params = new URLSearchParams(hash.substring(1));
                const token = params.get('access_token');
                if (token) {
                    localStorage.setItem('dropbox_token', token);
                    window.location.hash = ''; // Limpiar URL
                }
            }

            // Verificar si hay token guardado
            const token = localStorage.getItem('dropbox_token');
            if (token) {
                dbx = new Dropbox.Dropbox({ accessToken: token });
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('appSection').classList.remove('hidden');
                showStatus('‚úÖ Conectado a Dropbox', 'success');
                
                // Establecer fecha de hoy
                document.getElementById('fecha').valueAsDate = new Date();
            }
        };

        // Cargar archivo desde Dropbox
        async function loadFile() {
            if (!dbx) {
                showStatus('Error: No est√°s conectado a Dropbox', 'error');
                return;
            }

            const path = document.getElementById('filePath').value.trim();
            if (!path) {
                showStatus('Introduce la ruta del archivo', 'error');
                return;
            }

            currentFilePath = path;
            showStatus('üìÇ Cargando archivo...', 'info');

            try {
                const response = await dbx.filesDownload({ path: path });
                const blob = response.result.fileBlob;
                const content = await blob.text();
                
                // Parsear CSV
                parseCSV(content);
                
                // Mostrar secciones
                document.getElementById('addExpenseSection').classList.remove('hidden');
                document.getElementById('expenseListSection').classList.remove('hidden');
                
                showStatus('‚úÖ Archivo cargado correctamente', 'success');
                displayExpenses();
                
            } catch (error) {
                if (error.status === 409) {
                    showStatus('El archivo no existe. Se crear√° uno nuevo al guardar el primer gasto.', 'info');
                    expenses = [['Fecha', 'Concepto', 'Categor√≠a', 'Importe']]; // Headers
                    document.getElementById('addExpenseSection').classList.remove('hidden');
                    document.getElementById('expenseListSection').classList.remove('hidden');
                    displayExpenses();
                } else {
                    showStatus('Error: ' + error.message, 'error');
                    console.error(error);
                }
            }
        }

        // Parsear CSV
        function parseCSV(content) {
            const lines = content.trim().split('
');
            expenses = lines.map(line => {
                const values = [];
                let current = '';
                let inQuotes = false;
                
                for (let char of line) {
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim());
                return values;
            });
            
            // Si est√° vac√≠o, a√±adir headers
            if (expenses.length === 0) {
                expenses = [['Fecha', 'Concepto', 'Categor√≠a', 'Importe']];
            }
        }

        // Convertir a CSV
        function toCSV() {
            return expenses.map(row => 
                row.map(cell => {
                    const cellStr = String(cell);
                    if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('
')) {
                        return `"${cellStr.replace(/"/g, '""')}"`;
                    }
                    return cellStr;
                }).join(',')
            ).join('
');
        }

        // A√±adir gasto
        async function addExpense() {
            const fecha = document.getElementById('fecha').value;
            const concepto = document.getElementById('concepto').value.trim();
            const categoria = document.getElementById('categoria').value;
            const importe = document.getElementById('importe').value;

            // Validaciones
            if (!fecha) {
                showStatus('Selecciona una fecha', 'error');
                return;
            }
            if (!concepto) {
                showStatus('Introduce el concepto', 'error');
                return;
            }
            if (!importe || parseFloat(importe) <= 0) {
                showStatus('Introduce un importe v√°lido', 'error');
                return;
            }

            // Formatear fecha espa√±ola
            const fechaObj = new Date(fecha);
            const fechaFormateada = fechaObj.toLocaleDateString('es-ES');

            // A√±adir a array
            expenses.push([fechaFormateada, concepto, categoria, importe]);

            showStatus('üíæ Guardando en Dropbox...', 'info');

            try {
                // Convertir a CSV y subir
                const csvContent = toCSV();
                const blob = new Blob([csvContent], { type: 'text/csv' });
                
                await dbx.filesUpload({
                    path: currentFilePath || '/gastos.csv',
                    contents: blob,
                    mode: { '.tag': 'overwrite' }, // <-- SOBRESCRIBIR
                    autorename: false
                });

                // Limpiar formulario
                document.getElementById('concepto').value = '';
                document.getElementById('importe').value = '';
                
                displayExpenses();
                showStatus('‚úÖ Gasto guardado correctamente en Dropbox', 'success');
                
            } catch (error) {
                showStatus('Error al guardar: ' + error.message, 'error');
                console.error(error);
            }
        }

        // Mostrar lista de gastos
        function displayExpenses() {
            const container = document.getElementById('expenseList');
            
            if (expenses.length <= 1) {
                container.innerHTML = '<p style="text-align: center; color: #b8b8b8;">No hay gastos registrados</p>';
                return;
            }

            let html = '';
            // Mostrar √∫ltimos 10 gastos (sin contar header)
            const recentExpenses = expenses.slice(-10).reverse();
            
            recentExpenses.forEach(row => {
                if (row[0] === 'Fecha') return; // Saltar header
                
                html += `
                    <div class="expense-item">
                        <div class="expense-info">
                            <div style="font-weight: 600;">${row[1]}</div>
                            <div style="font-size: 0.85rem; color: #888;">${row[0]} ¬∑ ${row[2]}</div>
                        </div>
                        <div class="expense-amount">-${parseFloat(row[3]).toFixed(2)}‚Ç¨</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
    </script>
</body>
</html>
